---
title: "EDS 222 Final Project: Grape Quality and Environmental Predictors"
format: html
editor: visual
---

# 1. Context and Research Question

In viticulture, sugar content (Brix) is a key indicator of grape ripeness and quality. 

 
**Research Question:** *How does sun exposure, soil moisture, and other environmental and physiological factors influence Brix, and does soil moisture moderate the effect of sun exposure?*

# 2. Data

We use Kaggle data **Grape Quality** dataset which contains the variables:

-   `quality_score`: numeric outcome (rescaled to 0-1 for beta regression)
-   `variety`: categoorical predictor (grape type)
-   `region`: categorical predictor/stratifier
-   `sugar_content_brix`: numeric predictor (sugar concentration)
-   `acidity_ph`: numeric predictor (acidity level)
-   `sun_exposure_hours`: numeric predictor (environmental factor)
-   `soil_moisture_percent`: numeric predictor (environmental factor)
-   `rainfall_mm`: numeric predictor (environmental factor)
-   `cluster_weight_g`: numeric predictor (physiological trait)
-   `berry_size_mm`: numeric predictor (physiological trait)
-   `harvest_date`: temporal predictor (seasonal effect)

# DAG (Directed Acyclical Graph)

2.  Draw a DAG explaining the relationships between the variables.

region → sun_exposure_hours → sugar_content_brix → quality_score
region → rainfall_mm → soil_moisture_percent → sugar_content_brix
variety → sugar_content_brix
variety → acidity_ph → quality_scoresugar_content_brix
acidity_ph → quality_score
cluster_weight_g → sugar_content_brix
berry_size_mm → quality_score
harvest_date → sugar_content_brix

# Statistical Model

We will use a beta regression and scale Brix for between 0 and 1.

Response Family: Beta for a scaled Brix, bounded in (0,1)
Link function: Logit


Y_i ~ Beta(mu,omega,(1 - mu_i)omega)

logit(u_i) = Beta_0 + Beta_1 * Sun_i + Beta_2 * Moisture_i + Beta_3 * (Sun_i + Moisture_i) + Beta_4 * Rainfall_i + Beta_5 * ph_i Beta_6 * HarvestDate + Beta_7 * ClusterWeight_i + Beta_8 * Berry_Size + Variety_i + Region_i

### Notes: Included variety and region as categorical adjustment based on my DAG cofounders.

# Hypothesis

Hypothesis: After adjusting for variety and region, greater sun exposure and lower soil moisture are associated with higher sugar content (Brix)

Null Hypothesis: Thereis no association between sun exposure or soil moisture and Brix after adjustment


Alternative Hypothesis: More sun exposure increases Brix and higher soil moisture decreases Brix, controlling for variety and region

Later harvest dates will be associated with higher Brix

Outcome: Brix scaled from (0,1) for beta regression

Predictors:
- sun_exposure_hours
- soil_moisture_percent
- rainfall_mm
- acidity_ph
- harvest_date
- cluster_weight_g
- berry_size_mm

Adjusted for:
- variety
- region

Interaction: sun_exposure_hours x soil_moisture_%

Hypotheses Statistical Notation:

Test whether sun exposure increases Brix after adjustment
H0: B_Sun = 0 vs H1: B_Sun > 0

Test whether soil_moisture_% decreases Brix
H0: B_Moisture = 0 vs H1: B_Moisture < 0

----

sugar_content_brix \~ N(mu,sd)

mu = Beta0 + Beta1 \* (sun_exposure_hours) + Beta2 \* (rainfall_mm)

Hyp: H0: B_1 = 0; HA: B_1 \> 0

1.  List the variables you have or plan to collect. Include at least 3 predictors.

    1.  Predictors:
        1.  variety
        2.  sun_exposure_hours
        3.  rainfall_mm
        4.  region - predictor/stratifier
        5.  (Added) Soil Moisture Percentage

2.  Use a beta regression analysis to address this

3.  Are there any confounds? If so, where are the backdoor paths?

    1.  soil_moisture_percent

        1.  region\<- rainfall -\> soil moisture -\> score
        2.  variety \<- sugar content brix -\> quality score

    To address this, adjust for region and variety
    
------

```{r}
# Import libraries
library(tidyverse)
library(janitor)
library(ggplot2)
set.seed(0)
```

```{r}
# reading in data
grapes <- read.csv("GRAPE_QUALITY.csv") |> clean_names()
```

```{r}
# viewing a summary of the type of columns and values
str(grapes)
```

```{r}
# checking for NAs
which(is.na(grape_data))
```

```{r}
# summarizing columns
summary(grapes)
```

```{r}
# rescale Brix for beta regression
grapes <- grapes |>
  mutate(brix_scaled = (sugar_content_brix - min(sugar_content_brix) + .001) /
           (max(sugar_content_brix) - min(sugar_content_brix) + .002))

```

# 3. Exploratory Analysis


# Visualization

## Histogram of Brix

```{r}

ggplot(grapes, aes(x = sugar_content_brix)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "white") +
  labs(title = "Distribution of Brix (Sugar Content")


# Scatter plot of Sun vs Brix
ggplot(grapes, aes(x = sun_exposure_hours, y = sugar_content_brix)) +
  geom_point(alpha = .6) +
  labs(title = "Sun Exposure vs. Brix")
```



```{r}
# graphing and color coding the quality of grapes
ggplot(grapes, aes(rainfall_mm, sugar_content_brix, colour = quality_category)) +
  geom_point()

```

```{r}
# graphing and color coding the quality of grapes
ggplot(grape_data, aes(sun_exposure_hours, sugar_content_brix, colour = quality_category)) +
  geom_point()

```

```{r}
# graphing and color coding the quality of grapes
ggplot(grape_data, aes(rainfall_mm, quality_score, colour = quality_category)) +
  geom_point()
```

## We can see that scores of quality of grapes are about a half point each. We can see visually that the quality of grapes MAY go down as rainfall is low of high.

```{r}
#Plotting acidity as a response to variety

ggplot(grape_data, aes(acidity_ph,sugar_content_brix, colour = quality_category)) +
  geom_point()
```

```{r}
# graphing the quality score against sun exposure
ggplot(grape_data, aes(sun_exposure_hours, quality_score, colour = quality_category)) +
  geom_point()
```

# The graph depicts the positive increasing relationship, however, interestingly enough it seems that for each type of grape, incrasing sun exposore have a decreasing effect of measured grapes. This leads to believe that there is a sweet spot for sun exposure. Applying an analysis similar to pesticide abundance might prove useful.

## Interesting points

-   plot would be related to the ribbon and CI of means of scores
-   Based on the data, it seems that only high quality grapes tend to need 9+ hours of sun exposure
-   For low quality grapes, the number of these grapes tend to decrease as

```{r}
ggplot(grape_data, aes(quality_category)) +
  geom_bar()
```

# Based on this, we have a majority of grapes that are within the medium and high quality category. This may be due to just lack of data or a causal effect of variables

```{r}
grape_data %>%
  ggplot (aes(berry_size_mm)) +
  geom_density(fill = "darkgreen")
```

```{r}
  ggplot(grape_data, aes(x = quality_category, y =sugar_content_brix)) +
  geom_boxplot()
```

```{r}
  ggplot(grape_data, aes(x = quality_category, y = quality_score)) +
  geom_boxplot()
```

## Based on this graph, we can see that

```{r}
ggplot(grape_data, aes(x = region, y = quality_score)) +
  geom_boxplot()
```

```{r}
lm(grape_data, sugar_content_brix ~ soil_moisture_percent)
```

# Notes

What is the research question? - 'Tentative': How do environmental and physiological factors influence grape brix scores across different varieties and region? - Temporal Autocorrelation: - Can we group the grapes by species or region and order them by date and do a autocorrelation analysis? - Would need to use specific data ranges. - Apply Kreging in the analysis based on the spatial data assumptions - Use a beta regression
